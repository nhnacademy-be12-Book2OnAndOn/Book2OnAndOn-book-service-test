# GitHub Actions 워크플로우 이름
name: CI/CD Pipeline

on:
  # 'main' 또는 'master' 브랜치로 push 이벤트가 발생했을 때 실행
  push:
    branches: [ main, master ]
  # GitHub UI에서 수동으로 실행할 수 있도록 함 (workflow_dispatch)
  workflow_dispatch:

jobs:
  # 'build-and-deploy' 라는 이름의 단일 작업(job) 정의
  build-and-deploy:
    # 이 작업은 'self-hosted' 러너에서 실행됨
    runs-on: self-hosted

    steps:
      # 1. 코드 체크아웃
      # 리포지토리의 코드를 러너의 작업 디렉터리로 가져옴
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. mvnw 실행 권한 설정
      # Maven Wrapper 스크립트에 실행 권한을 부여
      - name: Set permissions
        run: chmod +x mvnw

      # 3. Maven으로 빌드
      # 테스트를 스킵하고 'package'를 실행하여 JAR 파일을 생성
      - name: Build with Maven
        run: ./mvnw clean package -DskipTests

      # 4. 빌드된 파일 복사
      # 생성된 JAR 파일과 배포 스크립트를 러너의 홈 디렉터리로 복사
      - name: Copy files to home directory
        run: |
          cp target/Book2OnAndOn-book-service-0.0.1-SNAPSHOT.jar ~/Book2OnAndOn-book-service-0.0.1-SNAPSHOT.jar
          cp deploy.sh ~/deploy.sh

      # 5. 배포 스크립트 실행
      # 홈 디렉터리로 이동한 후, 배포 스크립트에 실행 권한을 주고 실행
      - name: Deploy
        run: |
          cd ~
          chmod +x deploy.sh
          ./deploy.sh /usr/local/java/java21