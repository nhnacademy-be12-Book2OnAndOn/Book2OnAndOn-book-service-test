name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    # 1. 'self-hosted' 대신 GitHub의 최신 우분투 VM을 사용합니다.
    runs-on: ubuntu-latest

    steps:
      # 2. GitHub VM에 코드를 체크아웃합니다.
      - name: Checkout code
        uses: actions/checkout@v3

      # 3. GitHub VM에 Java 21 (빌드용)을 설치합니다.
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 4. mvnw 실행 권한을 부여합니다.
      - name: Set permissions
        run: chmod +x mvnw

      # 5. GitHub VM 안에서 Maven 빌드를 실행해 JAR 파일을 생성합니다.
      - name: Build with Maven
        run: ./mvnw clean package -DskipTests

      # 6. (scp) 빌드된 JAR 파일을 님의 서버로 복사(전송)합니다.
      #    이 단계는 위에서 등록한 Secret을 사용합니다.
      - name: SCP JAR to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          source: "target/Book2OnAndOn-book-service-0.0.1-SNAPSHOT.jar"
          target: "/home/backend/be12-team2" # 서버의 $HOME 경로
          strip_components: 1 # 'target/' 폴더 구조를 제외하고 JAR 파일만 보냅니다.

      # 7. (ssh) 님의 서버에 원격 접속해서 deploy.sh를 실행시킵니다.
      - name: Run Deploy Script on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            # deploy.sh 스크립트가 있는 $HOME으로 이동합니다.
            cd /home/backend/be12-team2 
            
            # 서버에 원래 있던 deploy.sh를 실행합니다.
            # 이제 ssh 세션이 끊어져도 'disown' 때문에 프로세스가 죽지 않습니다.
            chmod +x ./deploy.sh
            deploy-service.sh "github-action-test-0.0.1-SNAPSHOT.jar" 10423 10424 "default"
            
            
